{% extends "base.html" %} {% block content %}
<section class="text-gray-600 body-font">
  <div class="container px-5 py-24 mx-auto">
    <div class="flex flex-col text-center w-full mb-20">
      <h1
        class="sm:text-4xl text-3xl font-medium title-font mb-2 text-gray-900"
      >
        Payment & Split History
      </h1>
      <p class="lg:w-2/3 mx-auto leading-relaxed text-base">
        View your payment and split history below, paginated for easy navigation
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="border-2 border-gray-200 p-6 rounded-lg">
        <h2 class="text-lg font-medium text-gray-900 title-font mb-2">
          Total Debt
        </h2>
        <p class="leading-relaxed text-2xl">$ {{ debt }}</p>
      </div>

      <div class="border-2 border-gray-200 p-6 rounded-lg">
        <h2 class="text-lg font-medium text-gray-900 title-font mb-2">
          Debt Owed to You
        </h2>
        <p class="leading-relaxed text-2xl">$ {{ debt_owed }}</p>
      </div>

      <div class="border-2 border-gray-200 p-6 rounded-lg">
        <h2 class="text-lg font-medium text-gray-900 title-font mb-2">
          This Month's Expense
        </h2>
        <p class="leading-relaxed text-2xl">$ {{ expense }}</p>
      </div>
    </div>

    <div class="flex lg:flex-row flex-col w-full">
      <!-- Payments Column -->
      <div class="lg:w-1/2 w-full lg:pr-4">
        <h2 class="text-xl font-medium mb-4">Payment History</h2>
        <div class="overflow-auto">
          <table
            id="paymentHistoryTable"
            class="table-auto w-full text-left whitespace-no-wrap"
          >
            <thead>
              <tr>
                <th
                  class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100 rounded-tl rounded-bl"
                >
                  Date
                </th>
                <th
                  class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100"
                >
                  Amount
                </th>
                <th
                  class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100"
                >
                  Description
                </th>
              </tr>
            </thead>
            <tbody id="paymentHistoryBody">
              <!-- Rows will be populated dynamically with JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls for Payments -->
        <div class="flex justify-center mt-4">
          <button
            id="prevPagePayments"
            class="text-indigo-500"
            onclick="prevPage('payments')"
          >
            Previous
          </button>
          <span class="mx-2"
            >Page <span id="currentPagePayments">1</span> of
            <span id="totalPagesPayments"></span
          ></span>
          <button
            id="nextPagePayments"
            class="text-indigo-500"
            onclick="nextPage('payments')"
          >
            Next
          </button>
        </div>
      </div>

      <!-- Splits Column -->
      <div class="lg:w-1/2 w-full lg:pl-4 mt-6 lg:mt-0">
        <h2 class="text-xl font-medium mb-4">Split History</h2>
        <div class="overflow-auto">
          <table
            id="splitHistoryTable"
            class="table-auto w-full text-left whitespace-no-wrap"
          >
            <thead>
              <tr>
                <th
                  class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100 rounded-tl rounded-bl"
                >
                  Date
                </th>
                <th
                  class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100"
                >
                  Split for
                </th>
                <th
                  class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100"
                >
                  Payer
                </th>
                <th
                  class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100"
                >
                  Split Amount
                </th>
                <th
                  class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100"
                ></th>
              </tr>
            </thead>
            <tbody id="splitHistoryBody">
              <!-- Rows will be populated dynamically with JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls for Splits -->
        <div class="flex justify-center mt-4">
          <button
            id="prevPageSplits"
            class="text-indigo-500"
            onclick="prevPage('splits')"
          >
            Previous
          </button>
          <span class="mx-2"
            >Page <span id="currentPageSplits">1</span> of
            <span id="totalPagesSplits"></span
          ></span>
          <button
            id="nextPageSplits"
            class="text-indigo-500"
            onclick="nextPage('splits')"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
    const payments = {{ payments | tojson }}; // Convert the payments data to JSON
    const splits = {{ splits | tojson }}; // Convert the splits data to JSON
    const rowsPerPage = 10;

    let currentPagePayments = 1;
    let currentPageSplits = 1;
    const totalPagesPayments = Math.ceil(payments.length / rowsPerPage);
    const totalPagesSplits = Math.ceil(splits.length / rowsPerPage);

    document.getElementById('totalPagesPayments').textContent = totalPagesPayments;
    document.getElementById('totalPagesSplits').textContent = totalPagesSplits;

  function renderPage(type, page) {
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;

      if (type === 'payments') {
          const paymentHistoryBody = document.getElementById('paymentHistoryBody');
          paymentHistoryBody.innerHTML = ''; // Clear existing rows

          const pagePayments = payments.slice(start, end);
          pagePayments.forEach(payment => {
              const row = document.createElement('tr');

              const dateCell = document.createElement('td');
              dateCell.classList.add('px-4', 'py-3');
              dateCell.textContent = payment.time;

              const amountCell = document.createElement('td');
              amountCell.classList.add('px-4', 'py-3');
              amountCell.textContent = payment.amount;

              const descriptionCell = document.createElement('td');
              descriptionCell.classList.add('px-4', 'py-3');
              descriptionCell.textContent = payment.purpose;

              row.appendChild(dateCell);
              row.appendChild(amountCell);
              row.appendChild(descriptionCell);

              paymentHistoryBody.appendChild(row);
          });

          document.getElementById('currentPagePayments').textContent = currentPagePayments;
      }

      if (type === 'splits') {
          const splitHistoryBody = document.getElementById('splitHistoryBody');
          splitHistoryBody.innerHTML = ''; // Clear existing rows

          const pageSplits = splits.slice(start, end);
          pageSplits.forEach(split => {
              const row = document.createElement('tr');

              const dateCell = document.createElement('td');
              dateCell.classList.add('px-4', 'py-3');
              dateCell.textContent = split.time;

              const payeeCell = document.createElement('td');
              payeeCell.classList.add('px-4', 'py-3');
              payeeCell.textContent = split.user.name; // Access the user receiving the split

              const payerCell = document.createElement('td');
              payerCell.classList.add('px-4', 'py-3');
              payerCell.textContent = split.payer_id.name; // Access the payer's name

              const amountCell = document.createElement('td');
              amountCell.classList.add('px-4', 'py-3');
              amountCell.textContent = split.amount;

              const payButton = document.createElement('td');
              payButton.classList.add('px-4', 'py-3');

              // Show the pay button only if split.status is false and the user is not the current user
              if (split.user_id !== {{ current_user.id }}) {
                  if (split.status) {
                      payButton.textContent = 'Paid';
                  } else {
                      payButton.innerHTML = `<button class="text-indigo-500" onclick="toggleSplitStatus(${split.split_id})">Pay</button>`;
                  }
              }

              row.appendChild(dateCell);
              row.appendChild(payeeCell);
              row.appendChild(payerCell);
              row.appendChild(amountCell);
              row.appendChild(payButton);
              splitHistoryBody.appendChild(row);
          });

          document.getElementById('currentPageSplits').textContent = currentPageSplits;
      }
  }


    function toggleSplitStatus(splitId) {
      fetch(`/settleSplit/${splitId}`, {
        method: 'POST',
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Payment successful');
            renderPage('splits', currentPageSplits);
          } else {
            alert('Payment failed');
          }
        });
    }

    function nextPage(type) {
      if (type === 'payments' && currentPagePayments < totalPagesPayments) {
        currentPagePayments++;
        renderPage('payments', currentPagePayments);
      }
      if (type === 'splits' && currentPageSplits < totalPagesSplits) {
        currentPageSplits++;
        renderPage('splits', currentPageSplits);
      }
    }

    function prevPage(type) {
      if (type === 'payments' && currentPagePayments > 1) {
        currentPagePayments--;
        renderPage('payments', currentPagePayments);
      }
      if (type === 'splits' && currentPageSplits > 1) {
        currentPageSplits--;
        renderPage('splits', currentPageSplits);
      }
    }

    // Initial render
    renderPage('payments', currentPagePayments);
    renderPage('splits', currentPageSplits);
</script>
{% endblock %}
